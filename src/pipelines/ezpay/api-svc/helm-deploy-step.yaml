parameters:
  serviceConnection: ''
  svcPrincipalClientId: ''
  svcPrincipalSecret: ''
  azureTenantId: ''
  aksName: ''
  aksResourceGroup: ''
  containerRegistryName: ''
  imageRepositoryName: ''
  chartRepositoryName: ''
  k8sNamespace: ''
  helmReleaseName: ''
  chartName: ''
  env: ''
  replicas: ''
  frontDoorId: ''
  kongIngressClass: ''
  kongIngressUpstreamHostHeader: ''
  resourceLimitsCpu: ''
  resourceLimitsMemory: ''
  resourceRequestsCpu: ''
  resourceRequestsMemory: ''
  appInsightsKey: ''
  cosmosConnString: ''
  cosmosDatabase: ''
  cosmosContainer: ''
  serviceBusConnectionString: ''
  sbEventsTopic: ''
  sbPlatformEventsSubscription: ''
  sbPlatformEventsTopicConnectionString: ''
  b2cClientId: ''
  b2cDomainHost: ''
  b2cTenantId: ''
  b2cPolicyName: ''
  subsMgmtGrpcUrl: ''
  subsMgmtServiceId: ''
  subsMgmtApiKey: ''  
  wepayGrpcUrl: ''
  wepayApiVersion: ''
  wepayAppId: ''
  wepayAppToken: ''
  paymentsFromPhoneNumber: ''
  paymentsFromEmail: ''
  processPlatformEvents: ''
  blobStorageUrl: ''
  encryptPayerUrlToken: ''
  encryptionKey: ''
  ezpayTosVersion: ''
  statementsContainerName: ''
  invoiceContainerName: ''
  invoiceBlobConnectionString: ''
  urlShortenerUrl: ''
  payerPortalUrl: ''
  productApisOnly: ''
  apiKind: ''
  idempotencyMongoDbConnString: ''
  idempotencyMongoDbName: ''
  idempotencyMongoDbCollection: ''

steps:
- pwsh: |
    $env:HELM_EXPERIMENTAL_OCI = 1

    az login --service-principal -u $env:SP_CLIENT_ID -p $env:SP_SECRET --tenant $env:AZURE_TENANT_ID

    $fullRegistryName = "$env:CONTAINER_REGISTRY_NAME.azurecr.io"

    $env:SP_SECRET | helm registry login $fullRegistryName `
      --username $env:SP_CLIENT_ID `
      --password-stdin

    $latestHelmChart = az acr repository show-tags `
      --name $env:CONTAINER_REGISTRY_NAME `
      --repository $env:CHART_REPOSITORY_NAME `
      --top 1 `
      --orderby time_desc | ConvertFrom-Json

    $latestTag = az acr repository show-tags --name $env:CONTAINER_REGISTRY_NAME --repository $env:IMAGE_REPOSITORY_NAME --top 1 --orderby time_desc | ConvertFrom-Json
    $imageRepository = "$env:CONTAINER_REGISTRY_NAME.azurecr.io/$env:CHART_NAME"

    Write-Host ""
    $fullChartName = "$env:CONTAINER_REGISTRY_NAME.azurecr.io" + "/" + $env:CHART_REPOSITORY_NAME + ":" + $latestHelmChart
    Write-Host "fullChartName: $fullChartName"

    helm chart pull $fullChartName

    Write-Host ""
    helm chart export $fullChartName --destination .

    @"
    image:
      repository: $imageRepository
      tag: $latestTag

    commonLabels:
      env: $env:ENV

    deployment:
      replicas: $env:REPLICAS

    pod:
      resources:
        limits:
          cpu: $env:RESOURCE_LIMITS_CPU
          memory: $env:RESOURCE_LIMITS_MEMORY
        requests:
          cpu: $env:RESOURCE_REQUESTS_CPU
          memory: $env:RESOURCE_REQUESTS_MEMORY

    kongIngress:
      route:
        headers:
          x-azure-fdid:
          - $env:FRONT_DOOR_ID
      upstream:
        host_header: $env:KONG_INGRESS_UPSTREAM_HOST_HEADER

    ingress:
      annotations:
        kubernetes.io/ingress.class: $env:KONG_INGRESS_CLASS

    config:
      cosmos:
        connectionString: "$env:COSMOS_CONN_STRING"
        databaseName: "$env:COSMOS_DATABASE"
        containerName: "$env:COSMOS_CONTAINER"
      serviceBus:
        connectionString: "$env:SB_CONN_STRING"
        eventTopicConnectionString: "$env:SB_PLATFORM_EVENTS_TOPIC_CONN_STRING"
        eventsTopic: "$env:SB_EVENTS_TOPIC"
        platformEventsSubscription: "$env:SB_PLATFORM_EVENTS_SUBSCRIPTION"
      appInsights:
        instrumentationKey: "$env:APP_INSIGHTS_INSTRUMENTATION_KEY"
      b2c:
        clientId: "$env:B2C_CLIENT_ID"
        domainHost: "$env:B2C_DOMAIN_HOST"
        tenantId: "$env:B2C_TENANT_ID"
        policyName: "$env:B2C_POLICY_NAME"
      subsMgmt:
        grpcUrl: "$env:SUBS_MGMT_GRPC_URL"
        apiKey: "$env:SUBS_MGMT_API_KEY"
        serviceId: "$env:SUBS_MGMT_SERVICE_ID"
      wepay:
        grpcUrl: "$env:WEPAY_GRPC_URL"
        apiVersion: "$env:WEPAY_API_VERSION"
        appID: "$env:WEPAY_APP_ID"
        appToken: "$env:WEPAY_APP_TOKEN"
      idempotency:
        mongoDbConnString: "$env:MONGODB_CONN_STRING"
        mongoDbName: "$env:MONGODB_DATABASE"
        mongoDbCollection: "$env:MONGODB_IDEMPOTENCY_COLLECTION"        
      paymentsPlatformFromPhoneNumber: "$env:PAYMENTS_PLATFORM_FROM_PHONE_NUMBER"
      paymentsPlatformFromEmail: "$env:PAYMENTS_PLATFORM_FROM_EMAIL"
      processPlatformEvents: $env:PROCESS_PLATFORM_EVENTS
      blobStorageUrl: "$env:BLOB_STORAGE_URL"
      encryptPayerUrlToken: $env:ENCRYPT_PAYER_URL_TOKEN
      encryptionKey: "$env:ENCRYPTION_KEY"
      ezpayTOSVersion: "$env:EZPAY_TOS_VERSION"
      statementContainerName: "$env:STATEMENTS_CONTAINER_NAME"
      invoiceContainerName: "$env:INVOICE_CONTAINER_NAME"
      invoiceBlobConnectionString: "$env:INVOICE_BLOB_CONNECTION_STRING"
      urlShortenerUrl: "$env:LOGIC_APP_URL_SHORTENER_URL"
      merchantPortalUrl: "$env:BLOB_STORAGE_URL"
      payerPortalUrl: "$env:PAYER_PORTAL_BASE_URL"
      productAPIsOnly: $env:PRODUCT_APIS_ONLY
      apiKind: $env:API_KIND

    "@ | Out-File -FilePath ./deploy-values.yaml

    Write-Host ""
    Write-Host "Helm deploy prep complete!"
  displayName: Prep Helm Deploy
  name: prepHelmDeploy
  workingDirectory: $(System.DefaultWorkingDirectory)
  failOnStderr: true
  env:
    SP_CLIENT_ID: ${{ parameters.svcPrincipalClientId }}
    SP_SECRET: ${{ parameters.svcPrincipalSecret }}
    AZURE_TENANT_ID: ${{ parameters.azureTenantId }}
    CONTAINER_REGISTRY_NAME: ${{ parameters.containerRegistryName }}
    IMAGE_REPOSITORY_NAME: ${{ parameters.imageRepositoryName }}
    CHART_REPOSITORY_NAME: ${{ parameters.chartRepositoryName }}
    CHART_NAME: ${{ parameters.chartName }}
    ENV: ${{ parameters.env }}
    REPLICAS: ${{ parameters.replicas }}
    FRONT_DOOR_ID: ${{ parameters.frontDoorId }}
    KONG_INGRESS_CLASS: ${{ parameters.kongIngressClass }}
    KONG_INGRESS_UPSTREAM_HOST_HEADER: ${{ parameters.kongIngressUpstreamHostHeader }}
    RESOURCE_LIMITS_CPU: ${{ parameters.resourceLimitsCpu }}
    RESOURCE_LIMITS_MEMORY: ${{ parameters.resourceLimitsMemory }}
    RESOURCE_REQUESTS_CPU: ${{ parameters.resourceRequestsCpu }}
    RESOURCE_REQUESTS_MEMORY: ${{ parameters.resourceRequestsMemory }}
    APP_INSIGHTS_INSTRUMENTATION_KEY: ${{ parameters.appInsightsKey }}
    COSMOS_CONN_STRING: ${{ parameters.cosmosConnString }}
    COSMOS_DATABASE: ${{ parameters.cosmosDatabase }}
    COSMOS_CONTAINER: ${{ parameters.cosmosContainer }}
    SB_CONN_STRING: ${{ parameters.serviceBusConnectionString }} 
    SB_EVENTS_TOPIC: ${{ parameters.sbEventsTopic }}
    SB_PLATFORM_EVENTS_SUBSCRIPTION: ${{ parameters.sbPlatformEventsSubscription }}    
    SB_PLATFORM_EVENTS_TOPIC_CONN_STRING: ${{ parameters.sbPlatformEventsTopicConnectionString }}
    B2C_CLIENT_ID: ${{ parameters.b2cClientId }}
    B2C_DOMAIN_HOST: ${{ parameters.b2cDomainHost }}
    B2C_TENANT_ID: ${{ parameters.b2cTenantId }}
    B2C_POLICY_NAME: ${{ parameters.b2cPolicyName }}
    SUBS_MGMT_GRPC_URL: ${{ parameters.subsMgmtGrpcUrl }}
    SUBS_MGMT_SERVICE_ID: ${{ parameters.subsMgmtServiceId }}
    SUBS_MGMT_API_KEY: ${{ parameters.subsMgmtApiKey }}
    WEPAY_GRPC_URL: ${{ parameters.wepayGrpcUrl }}
    WEPAY_API_VERSION: ${{ parameters.wepayApiVersion }}
    WEPAY_APP_ID: ${{ parameters.wepayAppId }}
    WEPAY_APP_TOKEN: ${{ parameters.wepayAppToken }}
    PAYMENTS_PLATFORM_FROM_PHONE_NUMBER: ${{ parameters.paymentsFromPhoneNumber }}
    PAYMENTS_PLATFORM_FROM_EMAIL: ${{ parameters.paymentsFromEmail }}
    PROCESS_PLATFORM_EVENTS: ${{ parameters.processPlatformEvents }}
    BLOB_STORAGE_URL: ${{ parameters.blobStorageUrl }}
    ENCRYPT_PAYER_URL_TOKEN: ${{ parameters.encryptPayerUrlToken }}
    ENCRYPTION_KEY: ${{ parameters.encryptionKey }}
    EZPAY_TOS_VERSION: ${{ parameters.ezpayTosVersion }}
    STATEMENTS_CONTAINER_NAME: ${{ parameters.statementsContainerName }}
    INVOICE_CONTAINER_NAME: ${{ parameters.invoiceContainerName }}
    INVOICE_BLOB_CONNECTION_STRING: ${{ parameters.invoiceBlobConnectionString }}
    LOGIC_APP_URL_SHORTENER_URL: ${{ parameters.urlShortenerUrl }}
    PAYER_PORTAL_BASE_URL: ${{ parameters.payerPortalUrl }}
    PRODUCT_APIS_ONLY: ${{ parameters.productApisOnly }}
    API_KIND: ${{ parameters.apiKind }}
    MONGODB_IDEMPOTENCY_COLLECTION: ${{ parameters.idempotencyMongoDbCollection }}
    MONGODB_DATABASE: ${{ parameters.idempotencyMongoDbName }}
    MONGODB_CONN_STRING: ${{ parameters.idempotencyMongoDbConnString }}

- task: Kubernetes@1
  displayName: Kubectl Version
  name: kubectlVersion
  inputs:
    connectionType: 'Azure Resource Manager'
    azureSubscriptionEndpoint: ${{ parameters.serviceConnection }}
    azureResourceGroup: ${{ parameters.aksResourceGroup }}
    kubernetesCluster: ${{ parameters.aksName }}
    useClusterAdmin: true
    namespace: ${{ parameters.k8sNamespace }}
    command: 'version'
    arguments: '--short'

- task: HelmInstaller@1
  displayName: Helm Installer
  name: helmInstaller
  inputs:
    helmVersionToInstall: latest

- task: HelmDeploy@0
  displayName: Helm Deploy
  name: helmDeploy
  inputs:
    connectionType: 'Azure Resource Manager'
    azureSubscription: ${{ parameters.serviceConnection }}
    azureResourceGroup: ${{ parameters.aksResourceGroup }}
    kubernetesCluster: ${{ parameters.aksName }}
    useClusterAdmin: true
    namespace: ${{ parameters.k8sNamespace }}
    command: 'upgrade'
    chartType: 'FilePath'
    chartPath: ./${{ parameters.chartName }}
    releaseName: ${{ parameters.helmReleaseName }}
    valueFile: ./deploy-values.yaml
    install: true
    waitForExecution: false
    failOnStderr: false
