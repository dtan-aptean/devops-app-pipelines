trigger: none

variables:
- group: helm-chart-svc-principal-config

stages:
## ECOMM ERP SVC ##
- stage: TST_Ecomm_Erp_Svc_Helm_Deploy
  displayName: TST - ecomm-erp-svc Helm Deploy
  dependsOn: []

  jobs:
  - deployment: Helm_Deploy
    displayName: Helm Deploy
    environment: ecomm-tst

    pool:
      vmImage: 'ubuntu-latest'

    variables:
    - group: ecomm-erp-svc-tst
    - template: ../ecomm/erp-svc/helm-variables-tst.yaml

    strategy:
      runOnce:
        deploy:
          steps:
          - template: ../ecomm/erp-svc/helm-deploy-step.yaml
            parameters:
              serviceConnection: 'AzDevOps-Pipeline-Principal-DEV-TST-STG'
              svcPrincipalClientId: $(SVC_PRINCIPAL_CLIENT_ID_SHR)
              svcPrincipalSecret: $(SVC_PRINCIPAL_SECRET_SHR)
              azureTenantId: $(AZURE_TENANT_ID)
              aksName: $(AKS_NAME)
              aksResourceGroup: $(AKS_RESOURCE_GROUP)
              containerRegistryName: $(CONTAINER_REGISTRY_NAME)
              imageRepositoryName: $(IMAGE_REPOSITORY_NAME)
              chartRepositoryName: $(CHART_REPOSITORY_NAME)
              k8sNamespace: $(K8S_NAMESPACE)
              helmReleaseName: $(HELM_RELEASE_NAME)
              chartName: $(CHART_NAME)
              env: $(ENV)
              replicas: $(REPLICAS)
              resourceLimitsCpu: $(RESOURCE_LIMITS_CPU)
              resourceLimitsMemory: $(RESOURCE_LIMITS_MEMORY)
              resourceRequestsCpu: $(RESOURCE_REQUESTS_CPU)
              resourceRequestsMemory: $(RESOURCE_REQUESTS_MEMORY)
              cosmosDatabaseConnString: $(COSMOSDB_CONN_STRING)
              cosmosDatabase: $(COSMOSDB_DATABASE)
              cosmosCollectionName: $(COSMOSDB_COLLECTION_NAME)
              eventsIngressConnString: $(EVENTS_INGRESS_CONN_STRING)
              eventsIngressDestination: $(EVENTS_INGRESS_DESTINATION)
              nodeSelectorPool: $(NODE_SELECTOR_POOL)

- stage: STG_Ecomm_Erp_Svc_Helm_Deploy
  displayName: STG - ecomm-erp-svc Helm Deploy
  dependsOn: TST_Ecomm_Erp_Svc_Helm_Deploy

  jobs:
  - deployment: Helm_Deploy
    displayName: Helm Deploy
    environment: ecomm-stg

    pool:
      vmImage: 'ubuntu-latest'

    variables:
    - group: ecomm-erp-svc-stg
    - template: ../ecomm/erp-svc/helm-variables-stg.yaml

    strategy:
      runOnce:
        deploy:
          steps:
          - template: ../ecomm/erp-svc/helm-deploy-step.yaml
            parameters:
              serviceConnection: 'AzDevOps-Pipeline-Principal-DEV-TST-STG'
              svcPrincipalClientId: $(SVC_PRINCIPAL_CLIENT_ID_SHR)
              svcPrincipalSecret: $(SVC_PRINCIPAL_SECRET_SHR)
              azureTenantId: $(AZURE_TENANT_ID)
              aksName: $(AKS_NAME)
              aksResourceGroup: $(AKS_RESOURCE_GROUP)
              containerRegistryName: $(CONTAINER_REGISTRY_NAME)
              imageRepositoryName: $(IMAGE_REPOSITORY_NAME)
              chartRepositoryName: $(CHART_REPOSITORY_NAME)
              k8sNamespace: $(K8S_NAMESPACE)
              helmReleaseName: $(HELM_RELEASE_NAME)
              chartName: $(CHART_NAME)
              env: $(ENV)
              replicas: $(REPLICAS)
              resourceLimitsCpu: $(RESOURCE_LIMITS_CPU)
              resourceLimitsMemory: $(RESOURCE_LIMITS_MEMORY)
              resourceRequestsCpu: $(RESOURCE_REQUESTS_CPU)
              resourceRequestsMemory: $(RESOURCE_REQUESTS_MEMORY)
              cosmosDatabaseConnString: $(COSMOSDB_CONN_STRING)
              cosmosDatabase: $(COSMOSDB_DATABASE)
              cosmosCollectionName: $(COSMOSDB_COLLECTION_NAME)
              eventsIngressConnString: $(EVENTS_INGRESS_CONN_STRING)
              eventsIngressDestination: $(EVENTS_INGRESS_DESTINATION)
              nodeSelectorPool: $(NODE_SELECTOR_POOL)

- stage: PRD_Ecomm_Erp_Svc_Helm_Deploy
  displayName: PRD - ecomm-erp-svc Helm Deploy
  dependsOn: STG_Ecomm_Erp_Svc_Helm_Deploy

  jobs:
  - deployment: Helm_Deploy
    displayName: Helm Deploy
    environment: ecomm-prd

    pool:
      vmImage: 'ubuntu-latest'

    variables:
    - group: ecomm-erp-svc-prd
    - template: ../ecomm/erp-svc/helm-variables-prd.yaml

    strategy:
      runOnce:
        deploy:
          steps:
          - template: ../ecomm/erp-svc/helm-deploy-step.yaml
            parameters:
              serviceConnection: 'AzDevOps-Pipeline-Principal-PRD'
              svcPrincipalClientId: $(SVC_PRINCIPAL_CLIENT_ID_PRD)
              svcPrincipalSecret: $(SVC_PRINCIPAL_SECRET_PRD)
              azureTenantId: $(AZURE_TENANT_ID)
              aksName: $(AKS_NAME)
              aksResourceGroup: $(AKS_RESOURCE_GROUP)
              containerRegistryName: $(CONTAINER_REGISTRY_NAME)
              imageRepositoryName: $(IMAGE_REPOSITORY_NAME)
              chartRepositoryName: $(CHART_REPOSITORY_NAME)
              k8sNamespace: $(K8S_NAMESPACE)
              helmReleaseName: $(HELM_RELEASE_NAME)
              chartName: $(CHART_NAME)
              env: $(ENV)
              replicas: $(REPLICAS)
              resourceLimitsCpu: $(RESOURCE_LIMITS_CPU)
              resourceLimitsMemory: $(RESOURCE_LIMITS_MEMORY)
              resourceRequestsCpu: $(RESOURCE_REQUESTS_CPU)
              resourceRequestsMemory: $(RESOURCE_REQUESTS_MEMORY)
              cosmosDatabaseConnString: $(COSMOSDB_CONN_STRING)
              cosmosDatabase: $(COSMOSDB_DATABASE)
              cosmosCollectionName: $(COSMOSDB_COLLECTION_NAME)      
              eventsIngressConnString: $(EVENTS_INGRESS_CONN_STRING)
              eventsIngressDestination: $(EVENTS_INGRESS_DESTINATION)
              nodeSelectorPool: $(NODE_SELECTOR_POOL)
              
## ECOMM-GQL-API-SVC ##    
- stage: TST_Ecomm_Grpc_Api_Svc_Helm_Deploy
  displayName: TST - ecomm-gql-api-svc Helm Deploy
  dependsOn: []

  jobs:
  - deployment: Helm_Deploy
    displayName: Helm Deploy
    environment: ecomm-tst

    pool:
      vmImage: 'ubuntu-latest'

    variables:
    - group: ecomm-gql-api-svc-tst
    - template: ../ecomm/gql-api-svc/helm-variables-tst.yaml

    strategy:
      runOnce:
        deploy:
          steps:
          - template: ../ecomm/gql-api-svc/helm-deploy-step.yaml
            parameters:
              serviceConnection: 'AzDevOps-Pipeline-Principal-DEV-TST-STG'
              svcPrincipalClientId: $(SVC_PRINCIPAL_CLIENT_ID_SHR)
              svcPrincipalSecret: $(SVC_PRINCIPAL_SECRET_SHR)
              azureTenantId: $(AZURE_TENANT_ID)
              aksName: $(AKS_NAME)
              aksResourceGroup: $(AKS_RESOURCE_GROUP)
              containerRegistryName: $(CONTAINER_REGISTRY_NAME)
              imageRepositoryName: $(IMAGE_REPOSITORY_NAME)
              chartRepositoryName: $(CHART_REPOSITORY_NAME)
              k8sNamespace: $(K8S_NAMESPACE)
              helmReleaseName: $(HELM_RELEASE_NAME)
              chartName: $(CHART_NAME)
              env: $(ENV)
              replicas: $(REPLICAS)
              resourceLimitsCpu: $(RESOURCE_LIMITS_CPU)
              resourceLimitsMemory: $(RESOURCE_LIMITS_MEMORY)
              resourceRequestsCpu: $(RESOURCE_REQUESTS_CPU)
              resourceRequestsMemory: $(RESOURCE_REQUESTS_MEMORY)
              frontDoorId: $(FRONT_DOOR_ID)
              kongIngressClass: $(KONG_INGRESS_CLASS)
              kongIngressUpstreamHostHeader: $(KONG_INGRESS_UPSTREAM_HEADER)              
              grpcUrlErpIntegration: $(GRPC_URL_ERP_INTEGRATION)
              nodeSelectorPool: $(NODE_SELECTOR_POOL)
              subsMgmtGrpcUrl: $(GRPC_URL_SUBS_MGMT)
              subsMgmtServiceId: $(SUBS_MGMT_SERVICE_ID)
              subsMgmtApiKey: $(SUBS_MGMT_API_KEY)  

- stage: STG_Ecomm_Grpc_Api_Svc_Helm_Deploy
  displayName: STG - ecomm-gql-api-svc Helm Deploy
  dependsOn: TST_Ecomm_Grpc_Api_Svc_Helm_Deploy

  jobs:
  - deployment: Helm_Deploy
    displayName: Helm Deploy
    environment: ecomm-stg

    pool:
      vmImage: 'ubuntu-latest'

    variables:
    - group: ecomm-gql-api-svc-stg
    - template: ../ecomm/gql-api-svc/helm-variables-stg.yaml

    strategy:
      runOnce:
        deploy:
          steps:
          - template: ../ecomm/gql-api-svc/helm-deploy-step.yaml
            parameters:
              serviceConnection: 'AzDevOps-Pipeline-Principal-DEV-TST-STG'
              svcPrincipalClientId: $(SVC_PRINCIPAL_CLIENT_ID_SHR)
              svcPrincipalSecret: $(SVC_PRINCIPAL_SECRET_SHR)
              azureTenantId: $(AZURE_TENANT_ID)
              aksName: $(AKS_NAME)
              aksResourceGroup: $(AKS_RESOURCE_GROUP)
              containerRegistryName: $(CONTAINER_REGISTRY_NAME)
              imageRepositoryName: $(IMAGE_REPOSITORY_NAME)
              chartRepositoryName: $(CHART_REPOSITORY_NAME)
              k8sNamespace: $(K8S_NAMESPACE)
              helmReleaseName: $(HELM_RELEASE_NAME)
              chartName: $(CHART_NAME)
              env: $(ENV)
              replicas: $(REPLICAS)
              resourceLimitsCpu: $(RESOURCE_LIMITS_CPU)
              resourceLimitsMemory: $(RESOURCE_LIMITS_MEMORY)
              resourceRequestsCpu: $(RESOURCE_REQUESTS_CPU)
              resourceRequestsMemory: $(RESOURCE_REQUESTS_MEMORY)
              frontDoorId: $(FRONT_DOOR_ID)
              kongIngressClass: $(KONG_INGRESS_CLASS)
              kongIngressUpstreamHostHeader: $(KONG_INGRESS_UPSTREAM_HEADER)              
              grpcUrlErpIntegration: $(GRPC_URL_ERP_INTEGRATION)
              nodeSelectorPool: $(NODE_SELECTOR_POOL)
              subsMgmtGrpcUrl: $(GRPC_URL_SUBS_MGMT)
              subsMgmtServiceId: $(SUBS_MGMT_SERVICE_ID)
              subsMgmtApiKey: $(SUBS_MGMT_API_KEY)  

- stage: PRD_Ecomm_Grpc_Api_Svc_Helm_Deploy
  displayName: PRD - ecomm-gql-api-svc Helm Deploy
  dependsOn: STG_Ecomm_Grpc_Api_Svc_Helm_Deploy

  jobs:
  - deployment: Helm_Deploy
    displayName: Helm Deploy
    environment: ecomm-prd

    pool:
      vmImage: 'ubuntu-latest'

    variables:
    - group: ecomm-gql-api-svc-prd
    - template: ../ecomm/gql-api-svc/helm-variables-prd.yaml

    strategy:
      runOnce:
        deploy:
          steps:
          - template: ../ecomm/gql-api-svc/helm-deploy-step.yaml
            parameters:
              serviceConnection: 'AzDevOps-Pipeline-Principal-PRD'
              svcPrincipalClientId: $(SVC_PRINCIPAL_CLIENT_ID_PRD)
              svcPrincipalSecret: $(SVC_PRINCIPAL_SECRET_PRD)
              azureTenantId: $(AZURE_TENANT_ID)
              aksName: $(AKS_NAME)
              aksResourceGroup: $(AKS_RESOURCE_GROUP)
              containerRegistryName: $(CONTAINER_REGISTRY_NAME)
              imageRepositoryName: $(IMAGE_REPOSITORY_NAME)
              chartRepositoryName: $(CHART_REPOSITORY_NAME)
              k8sNamespace: $(K8S_NAMESPACE)
              helmReleaseName: $(HELM_RELEASE_NAME)
              chartName: $(CHART_NAME)
              env: $(ENV)
              replicas: $(REPLICAS)
              resourceLimitsCpu: $(RESOURCE_LIMITS_CPU)
              resourceLimitsMemory: $(RESOURCE_LIMITS_MEMORY)
              resourceRequestsCpu: $(RESOURCE_REQUESTS_CPU)
              resourceRequestsMemory: $(RESOURCE_REQUESTS_MEMORY)
              frontDoorId: $(FRONT_DOOR_ID)
              kongIngressClass: $(KONG_INGRESS_CLASS)
              kongIngressUpstreamHostHeader: $(KONG_INGRESS_UPSTREAM_HEADER)              
              grpcUrlErpIntegration: $(GRPC_URL_ERP_INTEGRATION)
              nodeSelectorPool: $(NODE_SELECTOR_POOL)
              subsMgmtGrpcUrl: $(GRPC_URL_SUBS_MGMT)
              subsMgmtServiceId: $(SUBS_MGMT_SERVICE_ID)
              subsMgmtApiKey: $(SUBS_MGMT_API_KEY)  
              nodejsEnv: 'production'

## ECOMM-LANG-SVC ##
- stage: TST_Ecomm_Lang_Svc_Helm_Deploy
  displayName: TST - Ecomm Language Svc Helm Deploy
  dependsOn: []

  jobs:
  - deployment: Helm_Deploy
    displayName: Helm Deploy
    environment: ecomm-tst

    pool:
      vmImage: 'ubuntu-latest'

    variables:
    - group: ecomm-lang-svc-tst
    - template: ../ecomm/lang-svc/helm-variables-tst.yaml

    strategy:
      runOnce:
        deploy:
          steps:
          - template: ../ecomm/lang-svc/helm-deploy-step.yaml
            parameters:
              serviceConnection: 'AzDevOps-Pipeline-Principal-DEV-TST-STG'
              svcPrincipalClientId: $(SVC_PRINCIPAL_CLIENT_ID_SHR)
              svcPrincipalSecret: $(SVC_PRINCIPAL_SECRET_SHR)
              azureTenantId: $(AZURE_TENANT_ID)
              aksName: $(AKS_NAME)
              aksResourceGroup: $(AKS_RESOURCE_GROUP)
              containerRegistryName: $(CONTAINER_REGISTRY_NAME)
              imageRepositoryName: $(IMAGE_REPOSITORY_NAME)
              chartRepositoryName: $(CHART_REPOSITORY_NAME)
              k8sNamespace: $(K8S_NAMESPACE)
              helmReleaseName: $(HELM_RELEASE_NAME)
              chartName: $(CHART_NAME)
              env: $(ENV)
              replicas: $(REPLICAS)
              frontDoorId: $(FRONT_DOOR_ID)
              kongIngressClass: $(KONG_INGRESS_CLASS)
              kongIngressUpstreamHostHeader: $(KONG_INGRESS_UPSTREAM_HEADER)
              resourceLimitsCpu: $(RESOURCE_LIMITS_CPU)
              resourceLimitsMemory: $(RESOURCE_LIMITS_MEMORY)
              resourceRequestsCpu: $(RESOURCE_REQUESTS_CPU)
              resourceRequestsMemory: $(RESOURCE_REQUESTS_MEMORY)
              cacheRetainSeconds: $(ECOMM_CACHE_RETAIN_SECONDS)
              cosmosConnString: $(COSMOSDB_CONN_STRING)
              cosmosDatabaseName: $(COSMOSDB_LANGUAGE_SVC_DATABASE)
              cosmosCollectionName: $(COSMOSDB_COLLECTION_NAME)
              nodeSelectorPool: $(NODE_SELECTOR_POOL)  

- stage: STG_Ecomm_Lang_Svc_Helm_Deploy
  displayName: STG - Ecomm Language Svc Helm Deploy
  dependsOn: TST_Ecomm_Lang_Svc_Helm_Deploy

  jobs:
  - deployment: Helm_Deploy
    displayName: Helm Deploy
    environment: ecomm-stg

    pool:
      vmImage: 'ubuntu-latest'

    variables:
    - group: ecomm-lang-svc-stg
    - template: ../ecomm/lang-svc/helm-variables-stg.yaml

    strategy:
      runOnce:
        deploy:
          steps:
          - template: ../ecomm/lang-svc/helm-deploy-step.yaml
            parameters:
              serviceConnection: 'AzDevOps-Pipeline-Principal-DEV-TST-STG'
              svcPrincipalClientId: $(SVC_PRINCIPAL_CLIENT_ID_SHR)
              svcPrincipalSecret: $(SVC_PRINCIPAL_SECRET_SHR)
              azureTenantId: $(AZURE_TENANT_ID)
              aksName: $(AKS_NAME)
              aksResourceGroup: $(AKS_RESOURCE_GROUP)
              containerRegistryName: $(CONTAINER_REGISTRY_NAME)
              imageRepositoryName: $(IMAGE_REPOSITORY_NAME)
              chartRepositoryName: $(CHART_REPOSITORY_NAME)
              k8sNamespace: $(K8S_NAMESPACE)
              helmReleaseName: $(HELM_RELEASE_NAME)
              chartName: $(CHART_NAME)
              env: $(ENV)
              replicas: $(REPLICAS)
              frontDoorId: $(FRONT_DOOR_ID)
              kongIngressClass: $(KONG_INGRESS_CLASS)
              kongIngressUpstreamHostHeader: $(KONG_INGRESS_UPSTREAM_HEADER)
              resourceLimitsCpu: $(RESOURCE_LIMITS_CPU)
              resourceLimitsMemory: $(RESOURCE_LIMITS_MEMORY)
              resourceRequestsCpu: $(RESOURCE_REQUESTS_CPU)
              resourceRequestsMemory: $(RESOURCE_REQUESTS_MEMORY)
              cacheRetainSeconds: $(ECOMM_CACHE_RETAIN_SECONDS)
              cosmosConnString: $(COSMOSDB_CONN_STRING)
              cosmosDatabaseName: $(COSMOSDB_LANGUAGE_SVC_DATABASE)
              cosmosCollectionName: $(COSMOSDB_COLLECTION_NAME)
              nodeSelectorPool: $(NODE_SELECTOR_POOL)

- stage: PRD_Ecomm_Lang_Svc_Helm_Deploy
  displayName: PRD - Ecomm Language Svc Helm Deploy
  dependsOn: STG_Ecomm_Lang_Svc_Helm_Deploy

  jobs:
  - deployment: Helm_Deploy
    displayName: Helm Deploy
    environment: ecomm-prd

    pool:
      vmImage: 'ubuntu-latest'

    variables:
    - group: ecomm-lang-svc-prd
    - template: ../ecomm/lang-svc/helm-variables-prd.yaml

    strategy:
      runOnce:
        deploy:
          steps:
          - template: ../ecomm/lang-svc/helm-deploy-step.yaml
            parameters:
              serviceConnection: 'AzDevOps-Pipeline-Principal-PRD'
              svcPrincipalClientId: $(SVC_PRINCIPAL_CLIENT_ID_PRD)
              svcPrincipalSecret: $(SVC_PRINCIPAL_SECRET_PRD)
              azureTenantId: $(AZURE_TENANT_ID)
              aksName: $(AKS_NAME)
              aksResourceGroup: $(AKS_RESOURCE_GROUP)
              containerRegistryName: $(CONTAINER_REGISTRY_NAME)
              imageRepositoryName: $(IMAGE_REPOSITORY_NAME)
              chartRepositoryName: $(CHART_REPOSITORY_NAME)
              k8sNamespace: $(K8S_NAMESPACE)
              helmReleaseName: $(HELM_RELEASE_NAME)
              chartName: $(CHART_NAME)
              env: $(ENV)
              replicas: $(REPLICAS)
              frontDoorId: $(FRONT_DOOR_ID)
              kongIngressClass: $(KONG_INGRESS_CLASS)
              kongIngressUpstreamHostHeader: $(KONG_INGRESS_UPSTREAM_HEADER)
              resourceLimitsCpu: $(RESOURCE_LIMITS_CPU)
              resourceLimitsMemory: $(RESOURCE_LIMITS_MEMORY)
              resourceRequestsCpu: $(RESOURCE_REQUESTS_CPU)
              resourceRequestsMemory: $(RESOURCE_REQUESTS_MEMORY)
              cacheRetainSeconds: $(ECOMM_CACHE_RETAIN_SECONDS)
              cosmosConnString: $(COSMOSDB_CONN_STRING)
              cosmosDatabaseName: $(COSMOSDB_LANGUAGE_SVC_DATABASE)
              cosmosCollectionName: $(COSMOSDB_COLLECTION_NAME)
              nodeSelectorPool: $(NODE_SELECTOR_POOL)

## ECOMM-STORE-FRONT ##
- stage: TST_Ecomm_SF_Helm_Deploy
  displayName: TST - Ecomm Storefront Helm Deploy

  jobs:
  - deployment: Helm_Deploy
    displayName: Helm Deploy
    environment: ecomm-tst

    pool:
      vmImage: 'ubuntu-latest'

    variables:
    - group: ecomm-sf-tst
    - template: ../ecomm/store-front/helm-variables-tst.yaml

    strategy:
      runOnce:
        deploy:
          steps:
          - template: ../ecomm/store-front/helm-deploy-step.yaml
            parameters:
              serviceConnection: 'AzDevOps-Pipeline-Principal-DEV-TST-STG'
              svcPrincipalClientId: $(SVC_PRINCIPAL_CLIENT_ID_SHR)
              svcPrincipalSecret: $(SVC_PRINCIPAL_SECRET_SHR)
              azureTenantId: $(AZURE_TENANT_ID)
              aksName: $(AKS_NAME)
              aksResourceGroup: $(AKS_RESOURCE_GROUP)
              containerRegistryName: $(CONTAINER_REGISTRY_NAME)
              imageRepositoryName: $(IMAGE_REPOSITORY_NAME)
              chartRepositoryName: $(CHART_REPOSITORY_NAME)
              k8sNamespace: $(K8S_NAMESPACE)
              helmReleaseName: $(HELM_RELEASE_NAME)
              chartName: $(CHART_NAME)
              env: $(ENV)
              replicas: $(REPLICAS)
              frontDoorId: $(FRONT_DOOR_ID)
              kongIngressClass: $(KONG_INGRESS_CLASS)
              kongIngressUpstreamHostHeader: $(KONG_INGRESS_UPSTREAM_HEADER)
              resourceLimitsCpu: $(RESOURCE_LIMITS_CPU)
              resourceLimitsMemory: $(RESOURCE_LIMITS_MEMORY)
              resourceRequestsCpu: $(RESOURCE_REQUESTS_CPU)
              resourceRequestsMemory: $(RESOURCE_REQUESTS_MEMORY)
              apteanTenantId: $(APTEAN_TENANT_ID)
              storeUrl: $(STORE_URL)
              adminEmail: $(ADMIN_EMAIL)
              adminPassword: $(ADMIN_PASSWORD)
              sqlConnString: $(SQL_CONN_STRING)
              sqlCommandTimeout: $(SQL_COMMAND_TIMEOUT)
              b2cClientId: $(B2C_CLIENT_ID)
              b2cTenantId: $(B2C_TENANT_ID)
              b2cDomainHost: $(B2C_DOMAIN_HOST)
              b2cPolicyName: $(B2C_POLICY_NAME)
              b2cRedirectUri: $(B2C_REDIRECT_URI)
              b2cDomainHint: $(B2C_DOMAIN_HINT)
              friendlyName: $(FRIENDLY_NAME)
              apteanPayApiUrl: $(APTEAN_PAY_API_URL)
              merchantPortalUrl: $(MERCHANT_PORTAL_URL)
              wepayAppId: $(WEPAY_APP_ID)
              wepayEnv: $(WEPAY_ENV)
              wepayApiVersion: $(WEPAY_API_VERSION)
              wepayApiKey: $(WEPAY_APP_TOKEN)
              useHttpClusterHttps: $(USE_HTTP_CLUSTER_HTTPS)
              useHttpXForwardedProto: $(USE_HTTP_X_FORWARDED_PROTO)
              forwardedHttpHeader: $(FORWARDED_HTTP_HEADER)
              displayFullErrorStack: $(DISPLAY_FULL_ERROR_STACK)
              blobStorageConnString: $(BLOB_STORAGE_CONN_STRING)
              blobStorageContainerName: $(BLOB_STORAGE_CONTAINER_NAME)
              blobStorageEndpoint: $(BLOB_STORAGE_ENDPOINT)
              blobStorageAppendContainerName: $(BLOB_STORAGE_APPEND_CONTAINER_NAME)
              useBlobStorageToStoreKeys: $(USE_BLOB_STORAGE_TO_STORE_KEYS)
              blobStorageContainerNameForKeys: $(BLOB_STORAGE_CONTAINER_NAME_FOR_KEYS)
              keyVaultIdForKeys: $(KEY_VAULT_ID_FOR_KEYS)
              enableRedis: $(ENABLE_REDIS)
              redisDatabaseId: $(REDIS_DATABASE_ID)
              redisConnString: $(REDIS_CONN_STRING)
              useRedisToStoreKeys: $(USE_REDIS_TO_STORE_KEYS)
              useRedisForCaching: $(USE_REDIS_FOR_CACHING)
              ignoreRedisTimeoutException: $(IGNORE_REDIS_TIMEOUT_EXCEPTION)
              useRedisToStorePluginsInfo: $(USE_REDIS_TO_STORE_PLUGINS_INFO)
              userAgentStringsPath: $(USER_AGENT_STRINGS_PATH)
              crawlerOnlyUserAgentStringsPath: $(CRAWLER_ONLY_USER_AGENT_STRINGS_PATH)
              disableSampleDataDuringInstallation: $(DISABLE_SAMPLE_DATA_DURING_INSTALLATION)
              pluginsIgnoredDuringInstallation: $(PLUGINS_IGNORED_DURING_INSTALLATION)
              clearPluginShadowDirOnStartup: $(CLEAR_PLUGIN_SHADOW_DIR_ON_STARTUP)
              copyLockedPluginAssemblies: $(COPY_LOCKED_PLUGIN_ASSEMBLIES)
              usePluginShadowCopy: $(USE_PLUGIN_SHADOW_COPY)
              useUnsafeLoadAssembly: $(USE_UNSAFE_LOAD_ASSEMBLY)
              useSessionStateTempDataProvider: $(USE_SESSION_STATE_TEMP_DATA_PROVIDER)
              apteanLanguagePluginApiUrl: $(APTEAN_LANGUAGE_PLUGIN_API_URL)
              eventsIngressConnString: $(EVENTS_INGRESS_CONN_STRING)
              eventsIngressDestination: $(EVENTS_INGRESS_DESTINATION)              

- stage: STG_Ecomm_SF_Helm_Deploy
  displayName: STG - Ecomm Storefront Helm Deploy
  dependsOn: TST_Ecomm_SF_Helm_Deploy

  jobs:
  - deployment: Helm_Deploy
    displayName: Helm Deploy
    environment: ecomm-stg

    pool:
      vmImage: 'ubuntu-latest'

    variables:
    - group: ecomm-sf-stg
    - template: ../ecomm/store-front/helm-variables-stg.yaml

    strategy:
      runOnce:
        deploy:
          steps:
          - template: ../ecomm/store-front/helm-deploy-step.yaml
            parameters:
              serviceConnection: 'AzDevOps-Pipeline-Principal-DEV-TST-STG'
              svcPrincipalClientId: $(SVC_PRINCIPAL_CLIENT_ID_SHR)
              svcPrincipalSecret: $(SVC_PRINCIPAL_SECRET_SHR)
              azureTenantId: $(AZURE_TENANT_ID)
              aksName: $(AKS_NAME)
              aksResourceGroup: $(AKS_RESOURCE_GROUP)
              containerRegistryName: $(CONTAINER_REGISTRY_NAME)
              imageRepositoryName: $(IMAGE_REPOSITORY_NAME)
              chartRepositoryName: $(CHART_REPOSITORY_NAME)
              k8sNamespace: $(K8S_NAMESPACE)
              helmReleaseName: $(HELM_RELEASE_NAME)
              chartName: $(CHART_NAME)
              env: $(ENV)
              replicas: $(REPLICAS)
              frontDoorId: $(FRONT_DOOR_ID)
              kongIngressClass: $(KONG_INGRESS_CLASS)
              kongIngressUpstreamHostHeader: $(KONG_INGRESS_UPSTREAM_HEADER)
              resourceLimitsCpu: $(RESOURCE_LIMITS_CPU)
              resourceLimitsMemory: $(RESOURCE_LIMITS_MEMORY)
              resourceRequestsCpu: $(RESOURCE_REQUESTS_CPU)
              resourceRequestsMemory: $(RESOURCE_REQUESTS_MEMORY)
              apteanTenantId: $(APTEAN_TENANT_ID)
              storeUrl: $(STORE_URL)
              adminEmail: $(ADMIN_EMAIL)
              adminPassword: $(ADMIN_PASSWORD)
              sqlConnString: $(SQL_CONN_STRING)
              sqlCommandTimeout: $(SQL_COMMAND_TIMEOUT)
              b2cClientId: $(B2C_CLIENT_ID)
              b2cTenantId: $(B2C_TENANT_ID)
              b2cDomainHost: $(B2C_DOMAIN_HOST)
              b2cPolicyName: $(B2C_POLICY_NAME)
              b2cRedirectUri: $(B2C_REDIRECT_URI)
              b2cDomainHint: $(B2C_DOMAIN_HINT)
              friendlyName: $(FRIENDLY_NAME)
              apteanPayApiUrl: $(APTEAN_PAY_API_URL)
              merchantPortalUrl: $(MERCHANT_PORTAL_URL)
              wepayAppId: $(WEPAY_APP_ID)
              wepayEnv: $(WEPAY_ENV)
              wepayApiVersion: $(WEPAY_API_VERSION)
              wepayApiKey: $(WEPAY_APP_TOKEN)
              useHttpClusterHttps: $(USE_HTTP_CLUSTER_HTTPS)
              useHttpXForwardedProto: $(USE_HTTP_X_FORWARDED_PROTO)
              forwardedHttpHeader: $(FORWARDED_HTTP_HEADER)
              displayFullErrorStack: $(DISPLAY_FULL_ERROR_STACK)
              blobStorageConnString: $(BLOB_STORAGE_CONN_STRING)
              blobStorageContainerName: $(BLOB_STORAGE_CONTAINER_NAME)
              blobStorageEndpoint: $(BLOB_STORAGE_ENDPOINT)
              blobStorageAppendContainerName: $(BLOB_STORAGE_APPEND_CONTAINER_NAME)
              useBlobStorageToStoreKeys: $(USE_BLOB_STORAGE_TO_STORE_KEYS)
              blobStorageContainerNameForKeys: $(BLOB_STORAGE_CONTAINER_NAME_FOR_KEYS)
              keyVaultIdForKeys: $(KEY_VAULT_ID_FOR_KEYS)
              enableRedis: $(ENABLE_REDIS)
              redisDatabaseId: $(REDIS_DATABASE_ID)
              redisConnString: $(REDIS_CONN_STRING)
              useRedisToStoreKeys: $(USE_REDIS_TO_STORE_KEYS)
              useRedisForCaching: $(USE_REDIS_FOR_CACHING)
              ignoreRedisTimeoutException: $(IGNORE_REDIS_TIMEOUT_EXCEPTION)
              useRedisToStorePluginsInfo: $(USE_REDIS_TO_STORE_PLUGINS_INFO)
              userAgentStringsPath: $(USER_AGENT_STRINGS_PATH)
              crawlerOnlyUserAgentStringsPath: $(CRAWLER_ONLY_USER_AGENT_STRINGS_PATH)
              disableSampleDataDuringInstallation: $(DISABLE_SAMPLE_DATA_DURING_INSTALLATION)
              pluginsIgnoredDuringInstallation: $(PLUGINS_IGNORED_DURING_INSTALLATION)
              clearPluginShadowDirOnStartup: $(CLEAR_PLUGIN_SHADOW_DIR_ON_STARTUP)
              copyLockedPluginAssemblies: $(COPY_LOCKED_PLUGIN_ASSEMBLIES)
              usePluginShadowCopy: $(USE_PLUGIN_SHADOW_COPY)
              useUnsafeLoadAssembly: $(USE_UNSAFE_LOAD_ASSEMBLY)
              useSessionStateTempDataProvider: $(USE_SESSION_STATE_TEMP_DATA_PROVIDER)
              apteanLanguagePluginApiUrl: $(APTEAN_LANGUAGE_PLUGIN_API_URL)
              eventsIngressConnString: $(EVENTS_INGRESS_CONN_STRING)
              eventsIngressDestination: $(EVENTS_INGRESS_DESTINATION)   